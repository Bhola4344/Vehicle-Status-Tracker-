<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vehicle Tracking</title>
  <link rel="icon" type="image/jpeg" href="logo.jpg">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <audio id="notifySound">
    <source src="https://actions.google.com/sounds/v1/doors/doorbell_chime.ogg" type="audio/ogg">
  </audio>
  <link rel="stylesheet" href="style-store.css">
</head>

<body>
  <div id="toast">Saved Successfully!</div>

  <div class="container-fluid">
    <div class="card mx-auto">

      <header class="header d-flex align-items-center justify-content-between">
        <div class="d-flex align-items-center gap-3">
          <img src="logo.jpg" alt="Logo" class="logo" style="width:auto; height:75px;">
          <div class="title">Balaji Action Buildwell Pvt. Ltd.<br><small style="font-weight:200;">Vehicle
              Tracking</small></div>
        </div>
        <!-- Logout Button -->
        <div class="d-flex align-items-center gap-3">
          <span id="welcomeUser" class="fw-bold" style="color:#0F3C73;"></span>
          <button class="btn btn-outline-danger btn-sm" onclick="logout()">Logout</button>
        </div>
      </header>

      <div class="status-board card mb-3 p-3">
        <div class="d-flex justify-content-between flex-wrap" id="statusBoard">

          <div class="status-card bg-info text-white p-2 rounded text-center flex-fill m-1"
            onclick="filterByStatus('')">
            Reported : <span id="totalReported">0</span>
          </div>

          <div class="status-card bg-primary text-white p-2 rounded text-center flex-fill m-1"
            onclick="filterByStatus('In Process')">
            In-process : <span id="totalEntered">0</span>
          </div>

          <div class="status-card bg-secondary text-white p-2 rounded flex-fill m-1"
            onclick="filterByStatus('Lab-Test')">
            Lab-Test : <span id="totalLabTesting">0</span>
          </div>

          <div class="status-card bg-warning text-dark p-2 rounded flex-fill m-1" onclick="filterByStatus('Unloading')">
            Unloading : <span id="totalUnloading">0</span>
          </div>

          <div class="status-card bg-secondary text-white p-2 rounded flex-fill m-1"
            onclick="filterByStatus('Loading')">
            Loading : <span id="totalLoading">0</span>
          </div>

          <div class="status-card bg-success text-white p-2 rounded text-center flex-fill m-1"
            onclick="filterByStatus('Complete')">
            Complete : <span id="totalOut">0</span>
          </div>

          <div class="status-card bg-danger text-white p-2 rounded text-center flex-fill m-1"
            onclick="filterByStatus('Pending')">
            Pending : <span id="totalPending">0</span>
          </div>


          <div class="status-card bg-dark text-white p-2 rounded text-center flex-fill m-1"
            onclick="filterByStatus('Hold')">
            Hold : <span id="totalHold">0</span>
          </div>

        </div>
      </div>



      <div class="d-flex flex-column flex-sm-row justify-content-between mb-2 mt-2 align-items-sm-center filter-bar">

        <div class="d-flex align-items-center gap-2 mb-2 mb-sm-0" style="flex-wrap:wrap;">
          <!-- Search -->
          <input type="text" class="form-control search-input common-input" placeholder="Search..."
            oninput="renderTable()" />

          <!-- Gate Filter -->
          <select id="gateFilter" class="form-control search-input common-input" onchange="renderTable()">
            <option value="">Select All Gate</option>
            <option value="C34A-GATE">C34A-GATE</option>
            <option value="C34-GATE">C34-GATE</option>
            <option value="C3-GATE">C3-GATE</option>
          </select>

          <!-- Start Date -->
          <input type="date" id="startDate" class="form-control search-input common-input" onchange="renderTable()" />

          <!-- End Date -->
          <input type="date" id="endDate" class="form-control search-input common-input" onchange="renderTable()" />
        </div>

        <!-- Buttons -->
        <div class="d-flex gap-2 mt-2 mt-sm-0 top-actions" style="flex-wrap:wrap;">
          <button class="btn btn-sm me-3" onclick="toggleSound()" id="soundBtn" style="
        width:35px;
        height:35px;
        border-radius:50%;
        background: linear-gradient(145deg, #b3d1f7, #8aa4d1);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
        color:#fff;
        border:none;
        font-size:18px;
        display:flex;
        align-items:center;
        justify-content:center;
        cursor:pointer;
        transition: all 0.3s ease;
      " onmouseover="this.style.transform='scale(1.2)';" onmouseout="this.style.transform='scale(1)';">üîä</button>

          <button class="btn btn-primary btn-sm btn-custom" id="refreshBtn" onclick="refreshData(this)">Refresh</button>
        </div>

      </div>



      <div class="table-container">
        <table id="dataTable" class="table table-sm table-striped table-hover">
          <thead>
            <tr>
              <th>ID</th>
              <th>Vehicle Type</th>
              <th>Vehicle No</th>
              <th>Material</th>
              <th>Qty</th>
              <th>Reporting Gate</th>
              <th>Reporting Time</th>
              <th>Driver Mobile</th>
              <th>Remark</th>
              <th>Store Response</th>
              <th>Response Time</th>
              <th>Response By</th>
              <th>Vehicle Status</th>
              <th>Store Remark</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="pagination" id="pagination"></div>
    </div>
  </div>

  <!-- VEHICLE LOG MODAL -->
  <div id="vehicleModal" style="
  position:fixed; inset:0;
  background:rgba(0,0,0,.35);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
">
    <div id="printArea" style="
    background:#fff; border-radius:14px; padding:18px 20px;
    width:95%; max-width:850px;
    box-shadow:0 20px 45px rgba(0,0,0,.25);
">

      <!-- Modal -->
      <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
        <b style="font-size:17px">VEHICLE LOG</b>
        <span style="cursor:pointer" class="no-print" onclick="closeVehicleModal()">‚úï</span>
      </div>

      <!-- SUMMARY BAR -->
      <div style="
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 14px 16px;
  padding: 14px 16px;
  border: 1px solid #e2e8f0;
  border-radius: 14px;
  margin-bottom: 14px;
  background: #ffffff;
  box-shadow: 0 6px 16px rgba(15, 23, 42, 0.06);
  font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
">

        <div>
          <div style="font-size: 12px; color:#6b7280; text-transform: uppercase; letter-spacing:.04em;">Vehicle No</div>
          <div style="font-size: 15px; font-weight: 700; color:#111827;" id="summaryVehicle"></div>
        </div>

        <div>
          <div style="font-size: 12px; color:#6b7280; text-transform: uppercase; letter-spacing:.04em;">Material</div>
          <div style="font-size: 15px; font-weight: 700; color:#111827;" id="summaryMaterial"></div>
        </div>

        <div>
          <div style="font-size: 12px; color:#6b7280; text-transform: uppercase; letter-spacing:.04em;">Qty</div>
          <div style="font-size: 15px; font-weight: 700; color:#111827;" id="summaryQty"></div>
        </div>

        <div>
          <div style="font-size: 12px; color:#6b7280; text-transform: uppercase; letter-spacing:.04em;">Reporting Time
          </div>
          <div style="font-size: 15px; font-weight: 700; color:#111827;" id="summaryReportingTime">-</div>
        </div>

        <div>
          <div style="font-size: 12px; color:#6b7280; text-transform: uppercase; letter-spacing:.04em;">Reporting Gate
          </div>
          <div style="font-size: 15px; font-weight: 700; color:#111827;" id="summaryReportingGate">-</div>
        </div>

      </div>

      <!-- TABLE -->
      <div style="overflow-x:auto;">
        <table style="width:100%; border-collapse:collapse; font-size:14px;">
          <thead>
            <tr style="background:#f1f5f9;">
              <th style="padding:10px; border-bottom:1px solid #e5e7eb; text-align:left;">Store Respond</th>
              <th style="padding:10px; border-bottom:1px solid #e5e7eb; text-align:left;">Vehicle Status</th>
              <th style="padding:10px; border-bottom:1px solid #e5e7eb; text-align:left;">Remark</th>
              <th style="padding:10px; border-bottom:1px solid #e5e7eb; text-align:left;">Respond By</th>
              <th style="padding:10px; border-bottom:1px solid #e5e7eb; text-align:left;">Time</th>
            </tr>
          </thead>
          <tbody id="vehicleLogRow">
            <!-- rows yahan append honge -->
          </tbody>
        </table>
      </div>
      <button class="print-btn no-print" onclick="printModal()">
        üñ®Ô∏è Print
      </button>
    </div>
  </div>

  <script>
    const SHEET_URL = "https://script.google.com/macros/s/AKfycbzmYWRmyRYFlDUmPagec97dv9iet2s_P5K7y1wVdNh5GUi51tyffZtE2ZIa0C-2FdZS/exec";
    let lastDataCount = 0;
    let statusFilter = "";
    let data = [];
    let currentPage = 1;
    const rowsPerPage = 12;
    let dropdownCache = {};

    // Check login status
    if (!sessionStorage.getItem('loggedIn')) {
      window.location.href = 'index.html';
    }

    function logout() {
      sessionStorage.removeItem('loggedIn');
      window.location.href = 'index.html';
    }

    function showToast(message, bgColor = '#28a745') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.style.background = bgColor;
      toast.style.display = 'block';
      toast.style.opacity = 1;

      setTimeout(() => {
        toast.style.transition = "opacity 0.5s";
        toast.style.opacity = 0;
        setTimeout(() => toast.style.display = 'none', 500);
      }, 2000);
    }




    function renderTable() {
      const gateVal = document.getElementById("gateFilter").value;
      const tbody = document.querySelector("#dataTable tbody");
      const search = document.querySelector(".search-input").value.toLowerCase();

      const startVal = document.getElementById("startDate").value;
      const endVal = document.getElementById("endDate").value;

      const startDate = startVal ? new Date(startVal + "T00:00:00") : null;
      const endDate = endVal ? new Date(endVal + "T23:59:59") : null;

      let filtered = data.filter(row => {
        let rowDate = null;
        if (row.timestamp) {
          const cleanTS = row.timestamp.replace(/(\d{2})-(\d{2})-(\d{4})/, "$3-$2-$1");
          rowDate = new Date(cleanTS);
        }

        if (startDate && rowDate && rowDate < startDate) return false;
        if (endDate && rowDate && rowDate > endDate) return false;

        const rowStr = Object.values(row).join(" ").toLowerCase();
        if (search && !rowStr.includes(search)) return false;

        if (gateVal && row.Gate !== gateVal) return false;

        if (statusFilter && row.Status !== statusFilter) return false;

        return true;
      });

      // IMPORTANT:
      // ------------------------------------
      window.filteredDataForDashboard = filtered;
      updateStatusBoard(filtered);
      // ------------------------------------

      filtered = filtered.reverse();

      const totalPages = Math.ceil(filtered.length / rowsPerPage);
      if (currentPage > totalPages) currentPage = 1;

      const start = (currentPage - 1) * rowsPerPage;
      const pageData = filtered.slice(start, start + rowsPerPage);

      tbody.innerHTML = "";

      if (pageData.length === 0) {
        tbody.innerHTML = `
    <tr>
      <td colspan="14" style="text-align:center; padding:15px; color:red; font-weight:bold;">
        No record found
      </td>
    </tr>
  `;
        renderPagination(0);
        return;
      }


      pageData.forEach(row => {
        const tr = document.createElement("tr");

        const reportingTime = row.timestamp ? formatDate(row.timestamp) : "-";
        const driverMobile = row.Mobile || "-";
        const remark = row.Notes || "-";
        const responseTime = row.ResponseTime ? formatDate(row.ResponseTime) : "-";

        tr.innerHTML = `
      <td>${row.ID}</td>
      <td>${row["Vehicle Type"]}</td>
      <td>
  <span class="vehicle-link"
        onclick='openVehicleModal(${JSON.stringify(row)})'>
    ${row["Vehicle No"]}
  </span>
</td>
      <td>${row.Material}</td>
      <td>${row.Quantity}</td>
      <td>${row.Gate}</td>
      <td>${reportingTime}</td>
      <td>${driverMobile}</td>
      <td class="remark-cell">${remark}</td>

      <td>
        <select class="form-select form-select-sm response-select"
          onchange="updateField(${row.ID}, 'Response', this.value);applyResponseColor(this)">
          <option value="Waiting">WAITING</option>
          <option value="Entry-C34A">ENTRY-C34A</option>
          <option value="Entry-C34">ENTRY-C34</option>
          <option value="Entry-C3">ENTRY-C3</option>
          <option value="Send to C34A">SEND TO C34A</option>
          <option value="Send to C34">SEND TO C34</option>
          <option value="Send to C3">SEND TO C3</option>
          <option value="Out">OUT</option>
        </select>
      </td>

      <td>${responseTime}</td>
      <td>${row.RespondBy ? getFirstTwoWords(row.RespondBy) : '-'}</td>

      <td>
        <select class="form-select form-select-sm status-select"
          onchange="updateField(${row.ID}, 'Status', this.value);applyStatusColor(this)">
          <option value="Pending">PENDING</option>
          <option value="In Process">IN PROCESS</option>
          <option value="Lab-Test">LAB-TEST</option>
          <option value="Unloading">UNLOADING</option>
          <option value="Hold">HOLD</option>
          <option value="Complete">COMPLETE</option>
          <option value="Loading">LOADING</option>
        </select>
      </td>

      <td><input type="text" class="form-control form-control-sm"
          value="${row.Remark || ''}"
          onchange="updateField(${row.ID}, 'Remark', this.value)" /></td>

      <td><button class="btn btn-success btn-sm btn-custom" onclick="updateRow(${row.ID}, this)">Save</button></td>
    `;

        tbody.appendChild(tr);

        const responseSelect = tr.querySelector(".response-select");
        const statusSelect = tr.querySelector(".status-select");

        responseSelect.value = row.Response;
        statusSelect.value = row.Status;

        dropdownCache[row.ID] = { Response: row.Response, Status: row.Status };

        applyResponseColor(responseSelect);
        applyStatusColor(statusSelect);
      });

      renderPagination(totalPages);
    }


    function applyResponseColor(select) {
      select.style.fontWeight = "bold";
      select.style.color = select.value === "Waiting" ? "red" : "green";
    }

    function applyStatusColor(select) {
      select.style.fontWeight = "bold";
      if (["Pending", "Hold"].includes(select.value)) select.style.color = "red";
      else if (["In Process", "Lab-Test", "Unloading", "Loading"].includes(select.value)) select.style.color = "orange";
      else if (select.value === "Complete") select.style.color = "green";
      else select.style.color = "black";
    }

    function updateField(id, field, value) {
      const row = data.find(r => r.ID == id);
      if (!row) return;

      row[field] = value;

      // Update timestamp and RespondBy only if Response changed from Waiting
      row.ResponseTime = new Date().toISOString();
      row.RespondBy = sessionStorage.getItem("userName") || "Unknown";

      // ‚ö° Save to cache immediately so table remembers before save
      dropdownCache[id] = {
        Response: row.Response,
        Status: row.Status
      };

      // Only apply color, do NOT re-render table here
      if (field === "Response") {
        const select = document.querySelector(`select.response-select[onchange*="updateField(${id}"]`);
        if (select) applyResponseColor(select);
      } else if (field === "Status") {
        const select = document.querySelector(`select.status-select[onchange*="updateField(${id}"]`);
        if (select) applyStatusColor(select);
      }
    }


    const VEHICLE_LOG_URL = "https://script.google.com/macros/s/AKfycbwGyv2OiosKuWOysaNrwPLjd7Uhw5QcpzXasPR1KYkUc34ss2ONN-tRhULXDOzw3GenOw/exec";
    async function updateRow(id, btn) {
      const row = data.find(r => r.ID == id);
      if (!row) return;

      // Set RespondBy and ResponseTime
      if (!row.RespondBy) row.RespondBy = sessionStorage.getItem("userName") || "Unknown";
      if (!row.ResponseTime) row.ResponseTime = new Date().toISOString();

      // FORM DATA for main SHEET_URL
      const formData = new FormData();
      formData.append("ID", row.ID);
      formData.append("Status", row.Status);
      formData.append("Remark", row.Remark);
      formData.append("Response", row.Response);
      formData.append("ResponseTime", row.ResponseTime);
      formData.append("RespondBy", row.RespondBy);

      btn.disabled = true;
      btn.textContent = "Saving...";

      try {
        // 1Ô∏è‚É£ Update existing main Sheet
        await fetch(SHEET_URL, { method: "POST", body: formData });

        // 2Ô∏è‚É£ Append row to vehicle log Sheet
        const logData = new URLSearchParams();
        logData.append("VehicleNo", row["Vehicle No"]);
        logData.append("StoreResponse", row.Response);
        logData.append("VehicleStatus", row.Status);
        logData.append("StoreRemark", row.Remark);
        logData.append("ResponseBy", row.RespondBy || "-");
        logData.append("Timestamp", row.ResponseTime);

        await fetch(VEHICLE_LOG_URL, { method: "POST", body: logData });

        showToast("‚úî Saved Successfully!");
        fetchData(false);
      } catch (e) {
        console.error(e);
        showToast("‚ö† Saved! (Network Issue)", "#dc3545");
        fetchData(false);
      } finally {
        btn.disabled = false;
        btn.textContent = "Save";
      }
    }

    async function refreshData(btn) {
      btn.disabled = true;
      btn.textContent = "Refreshing...";
      try {
        await fetchData(false);
      } catch (e) {
        showToast("Error fetching data", "#dc3545");
      } finally {
        btn.disabled = false;
        btn.textContent = "Refresh";
      }
    }

    fetchData();
    setInterval(() => fetchData(true), 40000);

    function formatDate(dt) {
      if (!dt) return "-";

      // Google Sheet se aayi string ko parse karna
      let d;
      if (typeof dt === "string") {
        // Sheet me 24/11/2025, 12:57 AM aata hai
        const parts = dt.split(","); // ["24/11/2025", " 12:57 AM"]
        if (parts.length === 2) {
          const dateParts = parts[0].trim().split("/"); // ["24","11","2025"]
          const timeParts = parts[1].trim().split(/[: ]/); // ["12","57","AM"]
          let hour = parseInt(timeParts[0], 10);
          const minute = parseInt(timeParts[1], 10);
          const ampm = timeParts[2];

          if (ampm.toUpperCase() === "PM" && hour !== 12) hour += 12;
          if (ampm.toUpperCase() === "AM" && hour === 12) hour = 0;

          d = new Date(
            parseInt(dateParts[2], 10),
            parseInt(dateParts[1], 10) - 1,
            parseInt(dateParts[0], 10),
            hour,
            minute
          );
        } else {
          d = new Date(dt); // fallback
        }
      } else {
        d = new Date(dt);
      }

      const now = new Date();
      const isToday =
        d.getDate() === now.getDate() &&
        d.getMonth() === now.getMonth() &&
        d.getFullYear() === now.getFullYear();

      let displayHour = d.getHours();
      let displayMinute = String(d.getMinutes()).padStart(2, "0");
      const ampm = displayHour >= 12 ? "PM" : "AM";
      displayHour = displayHour % 12;
      if (displayHour === 0) displayHour = 12;

      const timeStr = `${String(displayHour).padStart(2, "0")}:${displayMinute} ${ampm}`;

      if (isToday) return timeStr; // aaj ka time sirf show kare
      const day = String(d.getDate()).padStart(2, "0");
      const month = String(d.getMonth() + 1).padStart(2, "0");
      const year = d.getFullYear();

      return `${day}/${month}/${year}, ${timeStr}`;
    }

    function renderPagination(totalPages) {
      const pag = document.getElementById("pagination");
      pag.innerHTML = "";

      for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement("button");
        btn.textContent = i;

        if (i === currentPage) btn.classList.add("active");

        btn.onclick = () => {
          currentPage = i;
          renderTable();
        };
        pag.appendChild(btn);
      }
    }

    async function fetchData(isAutoRefresh = false) {
      try {
        const res = await fetch(SHEET_URL);
        const fetchedData = await res.json();

        // ----------- NEW CODE -----------
        if (fetchedData.length > lastDataCount && lastDataCount !== 0) {
          if (soundEnabled) {
            playAlertSound()
          }
        }
        lastDataCount = fetchedData.length; // update last count

        fetchedData.forEach(row => {
          if (isAutoRefresh && dropdownCache[row.ID]) {
            row.Response = dropdownCache[row.ID].Response;
            row.Status = dropdownCache[row.ID].Status;
          } else {
            row.Response = row.Response || "Waiting";
            row.Status = row.Status || "Pending";
          }
        });

        data = fetchedData;

        renderTable();

        // ‚≠ê MOST IMPORTANT FIX ‚≠ê
        updateStatusBoard(window.filteredDataForDashboard || data);

      } catch (e) {
        console.log("Error fetching data:", e);
      }
    }



    function updateStatusBoard(filtered) {
      const list = filtered || [];

      document.getElementById("totalReported").innerText = list.length;
      document.getElementById("totalEntered").innerText =
        list.filter(d => d.Status === "In Process" || d.Status === "Entered").length;

      document.getElementById("totalLabTesting").innerText =
        list.filter(d => d.Status === "Lab-Test").length;

      document.getElementById("totalUnloading").innerText =
        list.filter(d => d.Status === "Unloading").length;

      document.getElementById("totalLoading").innerText =
        list.filter(d => d.Status === "Loading").length;

      document.getElementById("totalPending").innerText =
        list.filter(d => d.Status === "Pending").length;

      document.getElementById("totalHold").innerText =
        list.filter(d => d.Status === "Hold").length;

      document.getElementById("totalOut").innerText =
        list.filter(d => d.Status === "Complete" || d.Status === "Out").length;
    }



    window.onload = function () {
      const today = new Date();
      const yesterday = new Date();
      yesterday.setDate(today.getDate() - 1); // kal

      const yyyyToday = today.getFullYear();
      const mmToday = String(today.getMonth() + 1).padStart(2, "0");
      const ddToday = String(today.getDate()).padStart(2, "0");
      const endDateStr = `${yyyyToday}-${mmToday}-${ddToday}`;

      const yyyyYest = yesterday.getFullYear();
      const mmYest = String(yesterday.getMonth() + 1).padStart(2, "0");
      const ddYest = String(yesterday.getDate()).padStart(2, "0");
      const startDateStr = `${yyyyYest}-${mmYest}-${ddYest}`;

      document.getElementById("startDate").value = startDateStr;
      document.getElementById("endDate").value = endDateStr;

      renderTable();
      populateItemFilter();

      // ‚≠ê DEFAULT ‚Äî Reported active
      const reportedCard = document.querySelector('.status-card[onclick="filterByStatus(\'\')"]');
      if (reportedCard) reportedCard.classList.add("active");
    };




    document.addEventListener("DOMContentLoaded", () => {
      const userName = sessionStorage.getItem("userName") || "Guest";
      document.getElementById("welcomeUser").innerText = "Welcome: " + userName;
    });

    function getFirstTwoWords(fullName) {
      if (!fullName) return "-";
      const parts = fullName.trim().split(" ");
      return parts.slice(0, 2).join(" "); // first 2 words
    }

    function playAlertSound() {
      if (!soundEnabled) return; // üîá OFF hoga to sound nahi bajega

      const audioSrc = "https://actions.google.com/sounds/v1/alarms/digital_watch_alarm_long.ogg";

      for (let i = 0; i < 1; i++) {
        setTimeout(() => {
          const beep = new Audio(audioSrc);
          beep.play();
        }, i * 500);
      }
    }

    let soundEnabled = true;

    function toggleSound() {
      soundEnabled = !soundEnabled;

      document.getElementById("soundBtn").innerText =
        soundEnabled ? "üîä" : "üîá";
    }

    function filterByStatus(status) {

      statusFilter = status;
      currentPage = 1;
      renderTable();

      document.querySelectorAll(".status-card")
        .forEach(c => c.classList.remove("active"));

      // jispe click hua usko active
      event.currentTarget.classList.add("active");
    }



    async function openVehicleModal(row) {
      if (!row) return;

      // ---- SUMMARY FIRST (instant) ----
      document.getElementById("summaryVehicle").innerText = row["Vehicle No"] || "-";
      document.getElementById("summaryMaterial").innerText = row.Material || "-";
      document.getElementById("summaryQty").innerText = row.Quantity || "-";
      document.getElementById("summaryReportingTime").innerText = formatDate(row.timestamp || row.ReportingTime || "");
      document.getElementById("summaryReportingGate").innerText = row.Gate || row.ReportingGate || "-";

      // Show modal IMMEDIATELY
      const tbody = document.getElementById("vehicleLogRow");
      tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;">Loading...</td></tr>`;
      document.getElementById("vehicleModal").style.display = "flex";

      // ---- FETCH IN BACKGROUND ----
      try {
        const res = await fetch(
          "https://script.google.com/macros/s/AKfycbwGyv2OiosKuWOysaNrwPLjd7Uhw5QcpzXasPR1KYkUc34ss2ONN-tRhULXDOzw3GenOw/exec",
          { cache: "no-store" }
        );

        const logData = await res.json();

        const vehicleLogs = logData.filter(
          r => r["Vehicle No"] === row["Vehicle No"]
        );

        if (!vehicleLogs.length) {
          tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;color:red;">No records found</td></tr>`;
          return;
        }

        tbody.innerHTML = "";

        vehicleLogs.forEach(r => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
        <td style="padding:8px; border-bottom:1px solid #e5e7eb;">${r["Store Response"] || "-"}</td>
        <td style="padding:8px; border-bottom:1px solid #e5e7eb;">${r["Vehicle Status"] || "-"}</td>
        <td style="padding:8px; border-bottom:1px solid #e5e7eb;">${r["Store Remark"] || "-"}</td>
        <td style="padding:8px; border-bottom:1px solid #e5e7eb;">${r["Response By"] || "-"}</td>
        <td style="padding:8px; border-bottom:1px solid #e5e7eb;">${formatDate(r.Timestamp || "")}</td>
      `;
          tbody.appendChild(tr);
        });

      } catch (err) {
        tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;color:red;">Error fetching data</td></tr>`;
        console.error(err);
      }
    }
    function closeVehicleModal() {
      const m = document.getElementById("vehicleModal");
      if (m) m.style.display = "none";
    }


    function printModal() {
      window.print();
    }
  </script>
</body>

</html>
